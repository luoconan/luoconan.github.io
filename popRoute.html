<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link href="./bootstrap.css" rel="stylesheet">
    <script src="js/jq.js"></script>
    <script src="./bootstrap.js"></script>
    <script src="./new_prt_info.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route_Sheet</title>
    <style>
        * {
            color: black;
        }

        .border {
            padding-left: 5px;
            padding-right: 5px;
        }

        #main {}

        #date {
            /*width:690px;*/
            text-align: center;
            padding: 10px 0;
        }

        #table {
            display: flex;
        }

        .table_d {
            margin-left: 90px;
        }

        .table {
            margin-left: 15px
        }

        .childTable {
            margin-right: 10px;
        }

        #driverToRoute table {
            border-collapse: separate;
            border-spacing: 0;
            width: 340px;
            margin: 24px auto;
            background: #f8fafc;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            border-radius: 12px;
            overflow: hidden;
            font-size: 1em;
        }

        #driverToRoute th,
        #driverToRoute td {
            padding: 10px 12px;
            text-align: center;
            border-bottom: 1px solid #e3e8ee;
        }

        #driverToRoute th {
            background: #e3f2fd;
            color: #2a4d69;
            font-weight: 600;
            font-size: 1.05em;
        }

        #driverToRoute tr:last-child td {
            border-bottom: none;
        }

        #driverToRoute input[type="text"],
        #driverToRoute input[type="number"],
        #driverToRoute input {
            border: 1px solid #b0bec5;
            border-radius: 6px;
            padding: 4px 8px;
            width: 60px;
            font-size: 1em;
            background: #fff;
        }

        #setDriverOnRoute {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 18px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
        }

        #setDriverOnRoute:hover {
            background: #1565c0;
        }
    </style>
</head>

<body>
    <div id="main" style="display: none;">
        <div id="date"></div>
        <div id="table"></div>
    </div>
    <div id="driverToRoute">
        <table>

        </table>
    </div>
</body>

</html>
<script>
    //alert(prtObjInfo["Ma, Cui Hua"])
    let orderBy = 0; //if 0 
    let today = new Date();
    let todayDate = (today.getMonth() + 1) + '-' + today.getDate() + '-' + today.getFullYear();
    let driversArr = ["Joe", "Mauricio", "Jackie", "Jerald", "Jerry", "Zhao", "Jabari", "Raymond", "Walter", "Lok", "Bert", "Jie","Wilson", "Sam", "Victor", "Conan"];
    let routeArr = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];

    (function ($) {
        $.getUrlParam = function (name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        }
    })(jQuery);




    function whichRoom(orgPrt) {
        let prt = orgPrt.split(" - @")[0]
        let tempPrt = "{@}" + orgPrt

        if (prtObjInfo[prt]) {
            let room = prtObjInfo[prt].room

            room = room == 1 ? "‚òÄ" :
                room == 2 ? "‚ú®" :
                    room == 3 ? "üåô" :
                        "üòÑ"

            tempPrt = room + tempPrt
        } else {
            tempPrt = "üòÑ" + tempPrt
        }

        return tempPrt;
    }
    function isWheelchair(prt) {
        let reStr = "‚ö†Ô∏è";
        if (prt.indexOf("Warning</b>") == -1) reStr = "-"
        return reStr;
    }

    function createTable(arr, isRoom) {
        let boder_style = 'border-secondary';
        let bg_style = 'bg-dark-subtle';
        let tableHtml = ""
        if (isRoom) {
            //$("#date").html(".")
            let tempTableHtml1 = `<table style="border:1px"><tr><th colspan="3" style="text-align: center"> </th></tr>`
            let tempTableHtml2 = roomName => `<tr><!--<th class="border border-dark ${bg_style}"></th>--><th class="border border-dark ${bg_style}">Prt&nbsp;@${roomName}</th><th class="border border-dark ${bg_style}">Rt#</th><th class="border border-dark ${bg_style}">‚ö†Ô∏è</th></tr>`;

            let sunTable = `<div class="childTable" id="sunRoom">` + tempTableHtml1 + tempTableHtml2("Sun");
            let starTable = `<div class="childTable" id="starRoom">` + tempTableHtml1 + tempTableHtml2("Star");
            let moonTable = `<div class="childTable" id="moonRoom">` + tempTableHtml1 + tempTableHtml2("Moon");
            let otherTable = `<div id="otherPrt">` + tempTableHtml1 + `other` + tempTableHtml2("Other");

            for (let i = 0, j = 1; i < arr.length; i++) {
                let room = arr[i][0].split("{@}")[0]; // ‚òÄ‚ú®üåô
                let prtVal=arr[i][0];
                let rtVal=routeArr[arr[i][1]];
                let wanderVal=arr[i][2];

                let prtTr = `<tr style="color:black">
                    <!--<td>${i}</td>-->
                    <td class="border border-dark">${prtVal.replace("{@}", "")}</td>
                    <td class="border border-dark">${rtVal}</td>
                    <td class="border border-dark">${wanderVal}</td>`

                if (room == "‚òÄ") {
                    sunTable += prtTr;
                } else if (room == "‚ú®") {
                    starTable += prtTr;
                } else if (room == "üåô") {
                    moonTable += prtTr;
                } else {
                    otherTable += prtTr;
                }
            }
            sunTable += "</table></div>";
            starTable += "</table></div>";
            if (`<div class="childTable" id="otherPrt">` + tempTableHtml1 + `other` + tempTableHtml2("unknown room") == otherTable) otherTable = ""
            moonTable += "</div></table><br>" + otherTable + "</table></div>";

            tableHtml = sunTable + starTable + moonTable

        } else {
            $("#date").html(todayDate + $.getUrlParam("rt"))
            let isMedication = $.getUrlParam("rt").indexOf("Medication List") !== -1
            if (isMedication) {
                let arr2 = (function () {
                    let tempArr = [...arr];
                    for (let i = 0; i < tempArr.length; i++) {
                        tempArr[i][0] = tempArr[i][0].replace("‚òÄ", "")
                        tempArr[i][0] = tempArr[i][0].replace("‚ú®", "")
                        tempArr[i][0] = tempArr[i][0].replace("üåô", "")
                        tempArr[i][0] = tempArr[i][0].replace("üòÑ", "")
                    }
                    return tempArr.sort()
                })()

                tableHtml = `<table style="border:1px">
                            <tr>
                                <!--<th class="border border-dark ${bg_style}"></th>-->
                                <th class="border border-dark ${bg_style}">Prt</th>
                                <th class="border border-dark ${bg_style}">Rt#</th>
                                <th class="border border-dark ${bg_style}">‚ö†Ô∏è</th>
                                <th class="border border-dark ${bg_style}" style="width:300px;">Signature</th>
                            </tr>`
                let row = arr.length
                for (let i = 0; i < row; i++) {
                    

                    let prtVal=arr[i][0];
                    let rtVal=routeArr[arr[i][1]];
                    let wanderVal=arr[i][2];
                    tableHtml += `<tr style="color:black">
                        <!--<td>${i}</td>-->
                        <td class="border border-dark">${prtVal.replace("{@}", "")}</td>
                        <td class="border border-dark">${rtVal}</td>
                        <td class="border border-dark">${wanderVal}</td>
                        <td class="border border-dark"> </td>`

                }


                tableHtml += "</table>"

            } else {
                tableHtml = `<table style="border:1px">
                             <tr>
                                <!--<th class="border border-dark ${bg_style}"></th>-->
                                <th class="border border-dark ${bg_style}">Prt</th>
                                <th class="border border-dark ${bg_style}">Rt#</th>
                                <th class="border border-dark ${bg_style}">‚ö†Ô∏è</th>
      
                                <th class="border border-dark ${bg_style}">&nbsp;</th>
                                <!--<th class="border border-dark ${bg_style}"></th>-->
                                <th class="border border-dark ${bg_style}">Prt</th>
                                <th class="border border-dark ${bg_style}">Rt#</th>
                                <th class="border border-dark ${bg_style}">‚ö†Ô∏è</th>
                             </tr>`;

                let row = parseInt(arr.length / 2 + .6)
                for (let i = 0; i < row; i++) {
                    let prtVal=arr[i][0];
                    let rtVal=routeArr[arr[i][1]];
                    let wanderVal=arr[i][2];
                    let r = parseInt(i + row);
                    //left side
                    tableHtml += `<tr style="color:black">
                        <!--<td>${i}</td>-->
                        <td class="border border-dark">${prtVal.replace("{@}", "")}</td>
                        <td class="border border-dark">${rtVal}</td>
                        <td class="border border-dark">${wanderVal}</td>
                        <td class="border border-dark ${bg_style}"></td>`
                    //right side

                    let r_prt = "", r_rtNum = "", r_wheelchair = ""
                    if (r < arr.length) {
                        r_prt = arr[r][0];
                        r_rtNum = routeArr[arr[r][1]];
                        r_wheelchair = arr[r][2]

                    }
                    tableHtml += `<!--<td>${r}</td>-->
                        <td class="border border-dark">${r_prt.replace("{@}", "")}</td>
                        <td class="border border-dark">${r_rtNum}</td>
                        <td class="border border-dark">${r_wheelchair}</td>
                    `
                }


                tableHtml += "</table>"
            }


        }
        $("#table").html(tableHtml)
        $("#table").removeClass("table")
        $("#table").addClass("table_d")
    }

    $(function () {
    let orgArr = eval($.getUrlParam("arr"));
    // Âè∏Êú∫‰∏éË∑ØÁ∫øË°®Ê†ºÊ®™ÂêëÂ±ïÁ§∫
    let driverHeader = driversArr.map((driver, i) => orgArr[i]?.length ? `<th>${driver}</th>` : '').join('');
    let driverInputs = driversArr.map((driver, i) => orgArr[i]?.length ? `<td><input id="arr${i}" class="routeNumber" value="${i}"></td>` : '').join('');
    let colSpan = driversArr.filter((_, i) => orgArr[i]?.length).length;

    $("#driverToRoute table").html(`
        <tr>${driverHeader}</tr>
        <tr>${driverInputs}</tr>
        <tr>
            <td colspan="${colSpan}" style="text-align:center;">
                <button id="setDriverOnRoute">Set</button>
            </td>
        </tr>
    `);

    // ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    $("#setDriverOnRoute").click(function () {
        $("#driverToRoute").hide();
        $("#main").show();

        $(".routeNumber").each(function () {
            let id = $(this).attr("id").replace("arr", "");
            let rt = $(this).val();
            routeArr[id] = rt;
        });

        let param = $.getUrlParam("arr");
        let pmArr = eval(param);
        if ($.getUrlParam("date") != null) todayDate = $.getUrlParam("date");

        // ÁªÑÂêàÊï∞ÊçÆ
        let byRouteArr = [];
        for (let i = 0; i < pmArr.length - 1; i++) {
            if (!pmArr[i]) continue;
            for (let j = 0; j < pmArr[i].length; j++) {
                let tempPrt = pmArr[i][j];
                let r = i == 0 ? "Joe" : i;
                byRouteArr.push([whichRoom(tempPrt.replace("__<b>Warning</b>", "")), r, isWheelchair(tempPrt)]);
            }
        }
        let byNameArr = [...byRouteArr].sort();

        // ÈªòËÆ§Â±ïÁ§∫
        createTable(byNameArr);

        // ÂàáÊç¢ÊéíÂ∫èÊñπÂºè
        $("#date").off("click").on("click", function () {
            const FORM_NUMBER = 3;
            $("#table").html("");
            orderBy++;
            if (orderBy % FORM_NUMBER == 0) {
                createTable(byNameArr);
            } else if (orderBy % FORM_NUMBER == 1) {
                createTable(byRouteArr);
            } else if (orderBy % FORM_NUMBER == 2) {
                let arr = [...byNameArr].sort((a, b) => a[1] - b[1]);
                createTable(arr, true);
                $("#table").addClass("table").removeClass("table_d");
            }
        });
    });
});
</script>
