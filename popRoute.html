<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link href="./bootstrap.css" rel="stylesheet">
    <script src="js/jq.js"></script>
    <script src="./bootstrap.js"></script>
    <script src="./new_prt_info.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route_Sheet</title>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ï¼Œæ–°å¢ textarea æ ·å¼ */
        * {
            color: black;
        }

        .border {
            padding-left: 5px;
            padding-right: 5px;
        }

        #main {}

        #date {
            /*width:690px;*/
            text-align: center;
            padding: 10px 0;
        }

        #table {
            display: flex;
        }

        .table_d {
            margin-left: 90px;
        }

        .table {
            margin-left: 15px
        }

        .childTable {
            margin-right: 10px;
        }

        #driverToRoute {
            text-align: center; /* ç¡®ä¿è¡¨æ ¼å’Œè¾“å…¥æ¡†å±…ä¸­ */
        }
        
        #driverToRoute table {
            border-collapse: separate;
            border-spacing: 0;
            width: 90%; /* è°ƒæ•´å®½åº¦ä½¿å…¶æ›´é€‚åº”å†…å®¹ */
            max-width: 800px;
            margin: 24px auto 10px auto; /* è°ƒæ•´ margin-bottom */
            background: #f8fafc;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            border-radius: 12px;
            overflow: hidden;
            font-size: 1em;
        }

        #driverToRoute th,
        #driverToRoute td {
            padding: 10px 12px;
            text-align: center;
            border-bottom: 1px solid #e3e8ee;
        }

        #driverToRoute th {
            background: #e3f2fd;
            color: #2a4d69;
            font-weight: 600;
            font-size: 1.05em;
        }

        #driverToRoute tr:last-child td {
            border-bottom: none;
        }

        #driverToRoute input[type="text"],
        #driverToRoute input[type="number"],
        #driverToRoute input {
            border: 1px solid #b0bec5;
            border-radius: 6px;
            padding: 4px 8px;
            width: 60px;
            font-size: 1em;
            background: #fff;
        }
        
        /* æ–°å¢ textarea æ ·å¼ */
        #prtInfoTable {
            width: 90%;
            max-width: 800px;
            height: 200px;
            margin: 20px auto;
            display: block;
            border: 1px solid #b0bec5;
            border-radius: 6px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.85em;
            text-align: left;
        }

        #setDriverOnRoute {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 18px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
        }

        #setDriverOnRoute:hover {
            background: #1565c0;
        }
    </style>
</head>

<body>
    <div id="main" style="display: none;">
        <div id="date"></div>
        <div id="table"></div>
    </div>
    
    <div id="driverToRoute">
        <table></table>
        
        <div style="margin-top: 20px;">
            <label for="prtInfoTable" style="display: block; margin-bottom: 5px; font-weight: bold; color: #2a4d69;">Prt Information Table (TSV)</label>
            <textarea id="prtInfoTable" placeholder="Paste the PRT info Table Here..."></textarea>
        </div>
    </div>
</body>

</html>
<script>
// --- å…¨å±€å˜é‡ä¸é…ç½® ---
let routeArr = Array.from({length: 16}, (_, i) => i.toString());

const CONFIG = {
    DRIVERS: ["Joe", "Mauricio", "Jackie", "Jerald", "Jerry", "Zhao", "Jabari", "Raymond", "Walter", "Lok", "Bert", "Jie", "Wilson", "Sam", "Victor", "Conan"],
    ROOM_MAP: { 1: "â˜€ï¸", 2: "âœ¨", 3: "ğŸŒ™", default: "ğŸ˜„" }
};

let state = {
    rawParticipants: [], 
    routeMap: Array.from({length: 16}, (_, i) => i.toString()), 
    displayMode: 0, 
    todayDate: new Date().toLocaleDateString('en-US').replace(/\//g, '-')
};

// --- å·¥å…·å‡½æ•° ---
const utils = {
    getParam: (name) => new URLSearchParams(window.location.search).get(name),
    
    parseRoomNum: (roomStr) => {
        if (!roomStr) return 3;
        const r = roomStr.toLowerCase();
        if (r.includes("sun")) return 1;
        if (r.includes("star")) return 2;
        return 3; 
    },

    // æ ¸å¿ƒæ¸…æ´—å‡½æ•°ï¼šä»…ç”¨äºâ€œå¯¹æ¯”â€æ€»è¡¨æ•°æ®
    // ä¾‹å¦‚ "Chin, Ang Lin - @@1344" -> "chin, ang lin"
    cleanPrtNameForMatch: (str) => {
        if (!str) return "";
        return str
            .replace(/\s*-\s*@@.*$/, "")       // å‰”é™¤ " - @@" åŠå…¶åç»­å†…å®¹
            .replace(/__<b>Warning<\/b>/g, "") // å‰”é™¤ Warning æ ‡ç­¾
            .replace(/<[^>]*>?/gm, '')         // å‰”é™¤æ‰€æœ‰ HTML æ ‡ç­¾
            .trim()
            .toLowerCase();                    // å¿½ç•¥å¤§å°å†™
    }
};

// --- æ•°æ®å¤„ç†å±‚ ---
function processData() {
    const tsvText = $("#prtInfoTable").val().trim();
    const urlArrStr = utils.getParam("arr");
    
    let tempPrtLibrary = {}; 

    // 1. è§£æ TSV æ€»è¡¨å†…å®¹ (ç”¨äºæå–æˆ¿é—´å’Œè½®æ¤…å±æ€§)
    if (tsvText) {
        const lines = tsvText.split('\n');
        const headers = lines[0].split('\t').map(h => h.trim());
        
        const nIdx = headers.findIndex(h => h.toLowerCase() === "name");
        const wIdx = headers.findIndex(h => h.toLowerCase() === "wander");
        const sIdx = headers.findIndex(h => h.toLowerCase() === "service type");
        const rmIdx = headers.findIndex(h => h.toLowerCase() === "room");

        if (nIdx !== -1) {
            lines.slice(1).forEach(line => {
                if (!line.trim()) return;
                const v = line.split('\t');
                const name = v[nIdx]?.trim();
                if (!name) return;

                tempPrtLibrary[name.toLowerCase()] = {
                    "originalName": name,
                    "room": utils.parseRoomNum(v[rmIdx]),
                    "isWander": (v[wIdx]?.trim() !== "" && v[wIdx]?.trim().toLowerCase() !== "n"),
                    "isWheelchair": v[sIdx]?.toLowerCase().includes("wheelchair")
                };
            });
            // åˆå¹¶åˆ°å…¨å±€å˜é‡
            prtObjInfo = Object.assign({}, prtObjInfo, tempPrtLibrary);
        }
    }

    // 2. åå•å¤„ç†ï¼šä¸¥æ ¼éµå¾ª URL ä¼ å‚çš„ä½ç½®
    let processed = [];
    if (urlArrStr) {
        try {
            const rawArr = JSON.parse(urlArrStr.replace(/'/g, '"'));
            rawArr.forEach((group, idx) => {
                if (!group) return;
                group.forEach(pString => {
                    // å¯¹æ¯”åï¼šå‰¥ç¦»æ ‡ç­¾å¹¶è½¬å°å†™
                    const matchName = utils.cleanPrtNameForMatch(pString);
                    
                    // è·å–å±æ€§ï¼ˆä»æ€»è¡¨åº“åŒ¹é…ï¼‰
                    let info = tempPrtLibrary[matchName];
                    if (!info) {
                        const legacyKey = Object.keys(prtObjInfo).find(k => k.toLowerCase() === matchName);
                        if (legacyKey) info = prtObjInfo[legacyKey];
                    }
                    
                    // çŠ¶æ€åˆ¤æ–­ï¼šå¦‚æœæœ‰æ€»è¡¨åˆ™çœ‹æ€»è¡¨ï¼Œå¦åˆ™çœ‹ URL æ ‡è®°
                    const isWanderActive = tsvText ? (info?.isWander || false) : pString.includes("Warning");
                    const isWheelchairActive = info?.isWheelchair || false;
                    const roomIcon = CONFIG.ROOM_MAP[info?.room] || CONFIG.ROOM_MAP.default;

                    processed.push({
                        displayName: pString.replace(/__<b>Warning<\/b>/g, ""), // æ˜¾ç¤ºåä¿ç•™åŸå§‹æ ¼å¼(å«@@)ï¼Œä»…å»æ‰Warningæ ‡ç­¾
                        matchName: matchName,
                        routeIndex: idx, // å¼ºåˆ¶æŒ‰ç…§ä¼ å‚ä¸­çš„ä½ç½®åˆ†é… Rt#
                        isWander: isWanderActive,
                        isWheelchair: isWheelchairActive,
                        roomIcon: roomIcon
                    });
                });
            });
        } catch (e) { console.error("Process Error:", e); }
    }
    state.rawParticipants = processed;
}

// --- æ¸²æŸ“å±‚ ---
function renderTable() {
    let displayArr = [...state.rawParticipants];
    const sortFn = (a, b) => {
        const rtA = state.routeMap[a.routeIndex] || "";
        const rtB = state.routeMap[b.routeIndex] || "";
        const rtRes = rtA.localeCompare(rtB, undefined, { numeric: true });
        // æ’åºä½¿ç”¨åŒ¹é…å(ä¸å«@@)æ›´ç¬¦åˆé€»è¾‘
        return rtRes !== 0 ? rtRes : a.matchName.localeCompare(b.matchName);
    };

    if (state.displayMode === 0) {
        displayArr.sort((a, b) => a.matchName.localeCompare(b.matchName));
    } else if (state.displayMode === 1) {
        displayArr.sort(sortFn);
    } else if (state.displayMode === 2) {
        displayArr.sort((a, b) => {
            if (a.roomIcon !== b.roomIcon) return a.roomIcon.localeCompare(b.roomIcon);
            return sortFn(a, b);
        });
    }
    createTable(displayArr, state.displayMode === 2);
}

// --- ç»˜å›¾å‡½æ•° ---
function createTable(dataList, isRoomMode) {
    const bg_style = 'bg-dark-subtle';
    let html = "";
    
    const getIcons = (p) => {
        let icons = "";
        if (p.isWander) icons += "âš ï¸";
        if (p.isWheelchair) icons += "â™¿ï¸";
        return icons || "-";
    };

    if (isRoomMode) {
        const createHeader = (title) => `<table style="border:1px"><tr><th colspan="3" style="text-align:center"> </th></tr><tr><th class="border border-dark ${bg_style}">Prt&nbsp;@${title}</th><th class="border border-dark ${bg_style}">Rt#</th><th class="border border-dark ${bg_style}">â‰ï¸</th></tr>`;
        
        let sunRows = "", starRows = "", moonRows = "", otherRows = "";

        dataList.forEach(p => {
            const row = `<tr style="color:black">
                <td class="border border-dark">${p.roomIcon}${p.displayName}</td>
                <td class="border border-dark">${state.routeMap[p.routeIndex]}</td>
                <td class="border border-dark">${getIcons(p)}</td>
            </tr>`;
            
            if (p.roomIcon === "â˜€ï¸") sunRows += row;
            else if (p.roomIcon === "âœ¨") starRows += row;
            else if (p.roomIcon === "ğŸŒ™") moonRows += row;
            else otherRows += row;
        });

        html += `<div class="childTable">${createHeader("Sun")}${sunRows}</table></div>`;
        html += `<div class="childTable">${createHeader("Star")}${starRows}</table></div>`;
        html += `<div class="childTable" style="display: flex; flex-direction: column; gap: 20px;">
                    <div>${createHeader("Moon")}${moonRows}</table></div>`;
        if (otherRows) html += `<div>${createHeader("Other")}${otherRows}</table></div>`;
        html += `</div>`;

        $("#table").removeClass("table_d").addClass("table").html(html);

    } else {
        $("#date").html(state.todayDate + " " + (utils.getParam("rt") || ""));
        const mid = Math.ceil(dataList.length / 2);
        const leftCol = dataList.slice(0, mid), rightCol = dataList.slice(mid);

        const buildColHtml = (list) => {
            if (list.length === 0) return "";
            let colHtml = `<div class="childTable"><table style="border:1px"><tr><th class="border border-dark ${bg_style}">Prt</th><th class="border border-dark ${bg_style}">Rt#</th><th class="border border-dark ${bg_style}">â‰ï¸</th></tr>`;
            list.forEach(p => {
                colHtml += `<tr style="color:black">
                    <td class="border border-dark">${p.roomIcon}${p.displayName}</td>
                    <td class="border border-dark">${state.routeMap[p.routeIndex]}</td>
                    <td class="border border-dark">${getIcons(p)}</td>
                </tr>`;
            });
            return colHtml + `</table></div>`;
        };

        html = buildColHtml(leftCol) + buildColHtml(rightCol);
        $("#table").removeClass("table").addClass("table_d").html(html);
    }
}

$(function () {
    processData();
    const activeIndices = new Set(state.rawParticipants.map(p => p.routeIndex));
    let headerHtml = "", inputHtml = "";
    
    CONFIG.DRIVERS.forEach((d, i) => {
        if (activeIndices.has(i) || activeIndices.size === 0) {
            headerHtml += `<th>${d}</th>`;
            inputHtml += `<td><input id="arr${i}" class="routeNumber" style="width:40px" value="${i}"></td>`;
        }
    });

    $("#driverToRoute table").html(`
        <tr>${headerHtml}</tr>
        <tr>${inputHtml}</tr>
        <tr><td colspan="${activeIndices.size || 16}" style="text-align:center; border-bottom:none;"><button id="btnSet" class="btn btn-primary mt-2">Set</button></td></tr>
    `);

    $("#btnSet").click(function () {
        $(".routeNumber").each(function () {
            state.routeMap[$(this).attr("id").replace("arr", "")] = $(this).val();
        });
        processData();
        $("#driverToRoute").hide();
        $("#main").show();
        renderTable();
    });

    $("#date").click(function() {
        state.displayMode = (state.displayMode + 1) % 3;
        renderTable();
    });
});
</script>

