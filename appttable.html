<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Trips</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #fff;
            color: #333;
            padding: 20px;
        }
        .date-info {
            text-align: left;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border: 2px solid #333;
        }
        th, td {
            border: 1px solid #999;
            padding: 4px 5px;
            text-align: left;
        }
        th {
            background-color: #667eea;
            color: white;
            font-weight: 600;
            border: 1px solid #555;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f0f0f0;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2rem;
        }
        .van-cell {
            cursor: pointer;
            user-select: none;
            text-align: center;
        }
        .van-cell:hover {
            background-color: #e8e8ff;
        }
        .escort-cell {
            text-align: center;
            cursor: pointer;
            user-select: none;
        }
        .escort-cell:hover {
            background-color: #e8e8ff;
        }
        .center-header {
            text-align: center;
        }
        .name-cell {
            cursor: grab;
            user-select: none;
        }
        .name-cell:active {
            cursor: grabbing;
        }
        tr.dragging {
            opacity: 0.5;
            background-color: #e8e8ff !important;
        }
        tr.drag-over {
            border-top: 3px solid #667eea;
        }
        .van-input {
            width: 80px;
            padding: 4px 6px;
            border: 2px solid #667eea;
            border-radius: 3px;
            font-size: inherit;
            outline: none;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 9999;
            font-size: 14px;
            pointer-events: none;
        }
        .date-info {
            cursor: pointer;
        }
        .date-info:hover {
            color: #667eea;
        }
        .note-cell {
            text-align: left;
            cursor: pointer;
        }
        .active-editing {
            background-color: #fff9c4 !important;
        }
        .column-editing-active {
            background-color: #ffeb3b !important;
        }
        .edit-textarea {
            width: 95%;
            min-height: 40px;
            font-family: inherit;
            font-size: inherit;
            border: 2px solid #667eea;
            border-radius: 3px;
            resize: vertical;
        }
        .done-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 2px 8px;
            cursor: pointer;
            border-radius: 3px;
        }
        .row-delete-btn {
            color: red;
            cursor: pointer;
            border: 1px solid #ccc;
            background: #fff;
        }
        @media print {
            body {
                padding: 10px;
            }
            th {
                background-color: #667eea !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .van-cell {
                cursor: default;
            }
            .toast {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="date-info" id="date-info"></div>
    <div id="table-container"></div>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const dateStr = urlParams.get('date') || '';
        const dataStr = urlParams.get('data') || '[]';

        // Format date as M/D/YYYY DayName
        function formatDate(dateStr) {
            if (!dateStr) return '';
            // dateStr is MM-DD-YYYY
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;

            const month = parseInt(parts[0]);
            const day = parseInt(parts[1]);
            const year = parseInt(parts[2]);

            const date = new Date(year, month - 1, day);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[date.getDay()];

            return `${month}/${day}/${year} ${dayName}`;
        }

        // Display date
        document.getElementById('date-info').textContent = formatDate(dateStr);

        // Parse data
        let trips = [];
        try {
            trips = JSON.parse(decodeURIComponent(dataStr));
        } catch (e) {
            console.error('Failed to parse data:', e);
        }

        // Build table
        const container = document.getElementById('table-container');

        if (trips.length === 0) {
            container.innerHTML = '<div class="no-data">No appointment trips found</div>';
        } else {
            let html = `
                <table id="appt-table">
                    <thead>
                        <tr>
                            <th class="center-header">Escort</th>
                            <th>Name</th>
                            <th>Appt Time</th>
                            <th>From Address</th>
                            <th>Appt Address</th>
                            <th class="center-header">A-Van#</th>
                            <th class="center-header">B-Van#</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            trips.forEach((trip, index) => {
                // Format time (HHMM -> HH:MM)
                let apptTime = trip.apptTime || '';
                if (apptTime.length === 4) {
                    apptTime = apptTime.substring(0, 2) + ':' + apptTime.substring(2);
                }

                // Format escort - show "-" if empty or "NO"
                let escort = (trip.escort || '').trim();
                if (!escort || escort.toLowerCase() === 'no') {
                    escort = '-';
                }

                html += `
                    <tr draggable="true" data-row-index="${index}">
                        <td class="escort-cell editable-cell" data-type="escort" data-index="${index}">${escort}</td>
                        <td class="name-cell">${trip.name || ''}</td>
                        <td>${apptTime}</td>
                        <td>${trip.fromAddress || ''}</td>
                        <td>${trip.apptAddress || ''}</td>
                        <td class="van-cell editable-cell" data-type="aVan" data-index="${index}">${trip.aVan || ''}</td>
                        <td class="van-cell editable-cell" data-type="bVan" data-index="${index}">${trip.bVan || ''}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Add click handlers for editable cells (escort, A-Van#, B-Van#)
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('click', handleCellClick);
            });

            // Add drag handlers for rows
            initDragAndDrop();
        }

        function initDragAndDrop() {
            const tbody = document.querySelector('#appt-table tbody');
            let draggedRow = null;

            tbody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('dragstart', (e) => {
                    draggedRow = row;
                    row.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                row.addEventListener('dragend', () => {
                    row.classList.remove('dragging');
                    tbody.querySelectorAll('tr').forEach(r => r.classList.remove('drag-over'));
                    draggedRow = null;
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (row !== draggedRow) {
                        row.classList.add('drag-over');
                    }
                });

                row.addEventListener('dragleave', () => {
                    row.classList.remove('drag-over');
                });

                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    row.classList.remove('drag-over');
                    if (row !== draggedRow && draggedRow) {
                        // Insert dragged row before or after current row
                        const allRows = Array.from(tbody.querySelectorAll('tr'));
                        const draggedIdx = allRows.indexOf(draggedRow);
                        const targetIdx = allRows.indexOf(row);

                        if (draggedIdx < targetIdx) {
                            row.parentNode.insertBefore(draggedRow, row.nextSibling);
                        } else {
                            row.parentNode.insertBefore(draggedRow, row);
                        }
                    }
                });
            });
        }

        function handleCellClick(e) {
            const cell = e.currentTarget;
            const isCtrl = e.ctrlKey || e.metaKey;
            const currentValue = cell.textContent.trim();
            const type = cell.dataset.type;

            // Create input
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'van-input';
            input.value = currentValue;
            // Store batch mode flag on input element
            input.dataset.batchMode = isCtrl ? 'true' : 'false';
            input.dataset.originalValue = currentValue;
            input.dataset.cellType = type;

            // Replace cell content with input
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            input.select();

            // Remove click handler temporarily
            cell.removeEventListener('click', handleCellClick);

            // Handle input completion
            function completeEdit() {
                const newValue = input.value.trim();
                const isBatchMode = input.dataset.batchMode === 'true';
                const origValue = input.dataset.originalValue;
                const cellType = input.dataset.cellType;

                cell.textContent = newValue;

                if (isBatchMode && origValue) {
                    // Determine which cells to update based on type
                    let selector;
                    if (cellType === 'escort') {
                        // Escort only affects escort column
                        selector = '.editable-cell[data-type="escort"]';
                    } else {
                        // A-Van# and B-Van# affect each other
                        selector = '.van-cell';
                    }

                    document.querySelectorAll(selector).forEach(otherCell => {
                        if (otherCell !== cell && otherCell.textContent.trim() === origValue) {
                            otherCell.textContent = newValue;
                        }
                    });
                }

                // Re-add click handler
                cell.addEventListener('click', handleCellClick);
            }

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    completeEdit();
                } else if (e.key === 'Escape') {
                    cell.textContent = currentValue;
                    cell.addEventListener('click', handleCellClick);
                }
            });

            input.addEventListener('blur', () => {
                // Small delay to allow Enter key to process first
                setTimeout(() => {
                    if (cell.contains(input)) {
                        completeEdit();
                    }
                }, 100);
            });
        }

        // ========== Enhanced Features (from Tampermonkey) ==========

        let isColumnAdded = false;

        // Toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Make cell editable with textarea (supports <br> for line breaks)
        function makeCellEditableWithTextarea(cell) {
            if (cell.querySelector('textarea')) return;

            const currentHTML = cell.innerHTML.trim();
            const editableValue = (currentHTML === '-' || currentHTML === '&nbsp;') ? '' : currentHTML;

            const textarea = document.createElement('textarea');
            textarea.className = 'edit-textarea';
            textarea.value = editableValue;

            cell.textContent = '';
            cell.appendChild(textarea);
            textarea.focus();

            textarea.onclick = (e) => e.stopPropagation();

            const finishEdit = () => {
                const val = textarea.value.trim();
                cell.innerHTML = val === '' ? '-' : val;
            };

            textarea.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    finishEdit();
                }
                if (e.key === 'Escape') {
                    cell.innerHTML = currentHTML || '-';
                }
            };
            textarea.onblur = finishEdit;
        }

        // Add Appt Note column and enable enhanced editing
        function addNoteColumn() {
            if (isColumnAdded) return;
            const table = document.getElementById('appt-table');
            if (!table) return;

            const theadRow = table.querySelector('thead tr');
            const tbodyRows = table.querySelectorAll('tbody tr');

            // 1. Insert Appt Note column
            const thNote = document.createElement('th');
            thNote.textContent = 'Appt Note';
            thNote.id = 'header-note';
            thNote.style.cursor = 'help';
            theadRow.insertBefore(thNote, theadRow.children[5]);

            tbodyRows.forEach(row => {
                const td = document.createElement('td');
                td.className = 'note-cell custom-editable';
                td.innerHTML = '';
                row.insertBefore(td, row.children[5]);
            });

            // 2. Adjust column widths
            const addressWidth = "16%";
            const noteWidth = "24%"; // 1.5x address
            theadRow.children[3].style.width = addressWidth; // From Address
            theadRow.children[4].style.width = addressWidth; // Appt Address
            theadRow.children[5].style.width = noteWidth;    // Appt Note

            // 3. Double-click header to toggle editing mode (all except Escort, A-Van#, B-Van#)
            // Columns: 0=Escort, 1=Name, 2=Appt Time, 3=From Address, 4=Appt Address, 5=Appt Note, 6=A-Van#, 7=B-Van#
            const editableColumns = [1, 2, 3, 4, 5]; // Name, Appt Time, From Address, Appt Address, Appt Note
            editableColumns.forEach(colIndex => {
                const th = theadRow.children[colIndex];
                if (!th) return;
                th.style.cursor = 'help';
                th.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                    const cells = table.querySelectorAll(`tbody tr td:nth-child(${colIndex + 1})`);
                    const isActive = th.classList.toggle('column-editing-active');

                    cells.forEach(c => {
                        c.classList.add('custom-editable');
                        c.classList.toggle('active-editing', isActive);
                    });
                    showToast(`${th.textContent} 编辑模式已${isActive ? '开启' : '关闭'}`);
                });
            });

            // 5. Event delegation for custom editable cells
            table.addEventListener('click', (e) => {
                const cell = e.target.closest('.custom-editable');
                if (cell && cell.classList.contains('active-editing')) {
                    if (e.target.tagName !== 'TEXTAREA') {
                        makeCellEditableWithTextarea(cell);
                    }
                }
            });

            // 6. Double-click Escort header to enter delete mode
            const thEscort = theadRow.children[0];
            thEscort.style.cursor = 'help';
            thEscort.ondblclick = () => enterDeleteMode(table);

            isColumnAdded = true;
            showToast("增强模式已启动，双击表头开启编辑，输入<br>可换行");
        }

        // Delete mode - hide rows only
        function enterDeleteMode(table) {
            if (document.getElementById('done-btn')) return;
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const headerRow = thead.querySelector('tr');

            // Add Done button column header
            const thDone = document.createElement('th');
            thDone.className = 'del-col-item';
            const doneBtn = document.createElement('button');
            doneBtn.id = 'done-btn';
            doneBtn.textContent = 'Done';
            doneBtn.className = 'done-btn';
            doneBtn.onclick = (e) => { e.stopPropagation(); exitDeleteMode(table); };
            thDone.appendChild(doneBtn);
            headerRow.appendChild(thDone);

            // Add delete button for each row
            tbody.querySelectorAll('tr').forEach(row => {
                const td = document.createElement('td');
                td.className = 'del-col-item';
                const btn = document.createElement('button');
                btn.textContent = 'X';
                btn.className = 'row-delete-btn';
                btn.onclick = (e) => { e.stopPropagation(); row.style.display = 'none'; };
                td.appendChild(btn);
                row.appendChild(td);
            });

            showToast("删除模式：点击 X 隐藏行");
        }

        function exitDeleteMode(table) {
            table.querySelectorAll('.del-col-item').forEach(el => el.remove());
            showToast("编辑完成");
        }

        // Initialize: click date to add note column
        document.getElementById('date-info').addEventListener('click', addNoteColumn);
    </script>
</body>
</html>
